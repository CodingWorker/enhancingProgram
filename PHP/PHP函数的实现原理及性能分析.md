#PHP函数的实现原理及性能分析（一）

##PHP函数的分类

- 横向划分
	- 内置函数
	- 用户自定义函数
		- 函数
		- 方法

- PHP函数的实现

开始->将PHP代码转换为语言片段->将Tokens转换为有意义的表达式->将表达式编译成Opcode->顺次执行Opcodes，从而实现PHP脚本的功能——>开始 的不断循环

php实现了一个典型的动态语言执行过程：拿到一段代码后，经过词法解析、语法解析等阶段后，源程序会被翻译成一个个指令(opcodes)，然后ZEND虚拟机顺次执行这些指令完成操作。

PHP本身使用C语言编写的，最终调用的也是C的函数

###内置函数

- 其本质上就是真正的C函数，因此对于内置函数的执行效率是很高的，与相应的c函数基本相同，唯一多了一次转发调用。
- 内置函数在php中都是通过so的方式进行动态加载，用户也可以根据需要自己编写相应的so，也就是我们常说的扩展。

###用户自定义函数

#PHP函数的实现原理及性能分析（二）

###类方法

##性能对比
- 函数名的长度对性能还是会有一定的影响
	- 一个建议是对于那些会调用很多次，本身功能又比较简单的函数，可以适当取一些言简意赅的名字。

- 函数个数增加时性能下降微乎其微，可以忽略
	- 所有的函数都放在一个hash表中，在不同个数下查找效率都应该还是接近于O(1)，所以性能差距不大。

- 内置函数调用的开销还是远低于用户函数。从前面原理分析可知主要差距在于用户函数调用时初始化符号表、接收参数等操作。

- 内置函数在总体性能上远高于普通用户函数。
	- 因此，函数使用的一个原则就是如果某功能有相应的内置函数，尽量使用它而不是自己编写php函数。对于一些涉及到大量字符串操作的功能，为提高性能，可以考虑用扩展来实现。

- 内置函数和C函数的开销在去掉php函数空调用的影响后差距较小，随着函数功能越来越复杂，双方性能趋近于相同

- php中的伪函数  isset  empty  unset  eval
	- 伪函数由于被直接翻译成指令来执行，和普通函数相比少了一次函数调用所带来的开销，因此性能会更好一些。

###建议

因此，对于php函数的使用，有如下一些建议

1. 一个功能可以用内置函数完成，尽量使用它而不是自己编写php函数。
2. 如果某个功能对性能要求很高，可以考虑用扩展来实现。
3. Php函数调用开销较大，因此不要过分封装。有些功能，如果需要调用的次数很多本身又只用1、2行代码就行实现的，建议就不要封装调用了。
4. 不要过分迷恋各种设计模式，如上一条描述，过分的封装会带来性能的下降。需要考虑两者的权衡。Php有自己的特点，切不可东施效颦，过分效仿java的模式。
5. 函数不宜嵌套过深，递归使用要谨慎。
6. 伪函数性能很高，同等功能实现下优先考虑。比如用isset代替array_key_exists
7. 函数返回引用没有太大意义，也起不到实际作用，建议不予考虑。
8. 类成员方法效率不比普通函数低，因此不用担心性能损耗。建议多考虑静态方法，可读性及安全性都更好。
9. 如不是特殊需要，参数传递都建议使用传值而不是传引用。当然，如果参数是很大的数组且需要修改时可以考虑引用传递。